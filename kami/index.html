<!DOCTYPE html>
<html>
<head>
  <title>Kami - 神之折纸</title>
  <meta charset="utf-8">
  <style type="text/css">
  * {
    margin: 0;
    padding: 0;
  }
  body {
    width: 600px;
    position: relative;
    margin: auto;
    text-align: center;
    background-color: white;
  }
  hr {
    margin: 10px 0px;
  }
  #board {
    width: 500px;
    line-height: 0em;
  }
  #selects {
    position: absolute;
    right: 0;
  }
  #selects div {
    width: 100px;
    min-height: 150px;
    position: relative;
  }
  #selects .selected:after {
    content: "";
    position: absolute;
    top: 0px;
    right: 0px;
    border-top: 15px solid white;
    border-right: 15px solid white;
    border-bottom: 15px solid #F9CC9D;
    border-left: 15px solid #F9CC9D;
  }
  .tile {
    display: inline-block;
    width: 50px;
    height: 50px;
    border: 1px dashed #ddd;
    transition: 0.5s;
    box-sizing: border-box;
  }
  #chooseLevel button {
    margin: 3px;
    width: 50px;
    height: 30px;
  }
  .tile:hover, button:hover, #selects div:hover {
    cursor: pointer;
  }
  </style>
</head>
<body>
<h1>Kami - Game <span id="levels"></span></h1>
<p>
  完美步数：<span id="ps"></span>
  <span>&nbsp;&nbsp;|&nbsp;&nbsp; </span>
  已用步数：<span id="us">0</span>
</p>
<div id="selects"></div>
<div id="board"></div>
<hr>
<div id="chooseLevel">
  <span>选关：</span>
</div>

<script type="text/javascript">
  var gameArr, level, prefectSteps, gameStr
  var selectedColor = ''
  var usedSteps = 0
  var width = 10
  var height = 16
  var colors = [
    '#6AC6AF', // blue
    '#D74A41', // red
    '#332814', // brown
    '#E66939', // orange
    '#8D9A80'  // gray
  ]
  var board = document.getElementById('board')
  var us = document.getElementById('us')
  var ps = document.getElementById('ps')
  var levels = document.getElementById('levels')
  var selects = document.getElementById('selects')
  var choose = document.getElementById('chooseLevel')

  window.onload = function () {
    for (let i = 0; i < levelsData.length; i++) {
      var butt = document.createElement('button')
      butt.innerText = i + 1
      butt.onclick = function () {
        init(i)
      }
      choose.appendChild(butt)
    }
    init(4)
  }

  function init (n) {
    selectedColor = ''
    usedSteps = 0
    level = levelsData[n].level
    prefectSteps = levelsData[n].prefectSteps
    gameStr = levelsData[n].gameStr
    levels.innerText = level
    ps.innerText = prefectSteps
    us.innerText = usedSteps
    gameArr = createBoardArray(gameStr)
    createBoard(gameArr)
    createSelects(gameStr)
  }

  function createSelects (s) {
    selects.innerHTML = ''
    s = new Set(s)
    s = Array.from(s)
    var h = parseInt(getComputedStyle(board).height) / s.length + 'px'
    for (let i = 0; i < s.length; i++) {
      var elem = document.createElement('div')
      elem.setAttribute('data-color', s[i])
      elem.style.backgroundColor = colors[parseInt(s[i])]
      elem.style.height = h
      elem.onclick = function () {
        selectedColor = parseInt(this.dataset.color)
        var ss = document.getElementsByClassName('selected')
        for (let i = 0; i < ss.length; i++) {
          ss[i].className = ''
        }
        this.className = 'selected'
      }
      selects.appendChild(elem)
    }
  }

  function createBoardArray (game) {
    var r = []
    for (let i = 0; i < height; i++) {
      var temp = []
      for (let j = 0; j < width; j++) {
        temp.push(parseInt(game[i * width + j]))
      }
      r.push(temp)
    }
    return r
  }

  function createBoard (arr) {
    board.innerHTML = ''
    for (let i = 0; i < arr.length; i++) {
      for (let j = 0; j < arr[i].length; j++) {
        var elem = document.createElement('div')
        elem.setAttribute('class', 'tile')
        elem.setAttribute('id', i + '-' + j)
        elem.style.backgroundColor = colors[arr[i][j]]
        elem.onclick = function () {
          if (selectedColor === '') { return }
          changeColor(i, j, colors[selectedColor])
          usedSteps++
          us.innerText = usedSteps
          if (isDone(gameArr)) {
            setTimeout(function () {
              if (usedSteps <= prefectSteps) {
                alert('Prefect!')
              } else if (usedSteps - prefectSteps < 3) {
                alert('OK')
              } else {
                alert('Just so so')
              }
            }, 2000)
          }
        }
        board.appendChild(elem)
      }
    }
  }

  function getGroup (arr, x, y, color) {
    var result = []
    var checked = []
    var type = arr[x][y]
    connect(x, y)
    var delay = 100
    var changed = [x + '-' + y]
    change(x, y)
    return result

    function connect (x, y) {
      var str = x + '-' + y
      if (checked.indexOf(str) < 0) {
        checked.push(str)
        result.push([x, y])
        if (arr[x - 1] && arr[x - 1][y] === type) {
          connect(x - 1, y)
        }
        if (arr[x + 1] && arr[x + 1][y] === type) {
          connect(x + 1, y)
        }
        if (arr[x][y - 1] === type) {
          connect(x, y - 1)
        }
        if (arr[x][y + 1] === type) {
          connect(x, y + 1)
        }
      }
    }
    function change (x, y) {
      var id = x + '-' + y
      document.getElementById(id).style.backgroundColor = color
      var shang = (x - 1) + '-' + y
      if (checked.indexOf(shang) >= 0 && changed.indexOf(shang) < 0) {
        changed.push(shang)
        setTimeout(function () {
          change(x - 1, y)
        }, delay)
      }
      var xia = (x + 1) + '-' + y
      if (checked.indexOf(xia) >= 0 && changed.indexOf(xia) < 0) {
        changed.push(xia)
        setTimeout(function () {
          change(x + 1, y)
        }, delay)
      }
      var zuo = x + '-' + (y - 1)
      if (checked.indexOf(zuo) >= 0 && changed.indexOf(zuo) < 0) {
        changed.push(zuo)
        setTimeout(function () {
          change(x, y - 1)
        }, delay)
      }
      var you = x + '-' + (y + 1)
      if (checked.indexOf(you) >= 0 && changed.indexOf(you) < 0) {
        changed.push(you)
        setTimeout(function () {
          change(x, y + 1)
        }, delay)
      }
    }
  }

  function changeColor (x, y, color) {
    var c = color
    var groups = getGroup(gameArr, x, y, color)
    for (let i = 0; i < groups.length; i++) {
      gameArr[groups[i][0]][groups[i][1]] = colors.indexOf(c)
    }
  }

  function isDone (arr) {
    arr = Array.prototype.concat.apply([], arr)
    for (let i = 0; i < arr.length - 1; i++) {
      if (arr[i] !== arr[i + 1]) {
        return false
      }
    }
    return true
  }
  var levelsData = [
    {
      level: 1,
      prefectSteps: 1,
      gameStr: '1111111111111111111111111111111111111111111111111111111111111111111111111111111122222222222222222222222222222222222222222222222222222222222222222222222222222222'
    },
    {
      level: 2,
      prefectSteps: 1,
      gameStr: '0000000000000000000000000000000011111100001111110000111111000011111100001111110000111111000011111100001111110000111111000011111100000000000000000000000000000000'
    },
    {
      level: 3,
      prefectSteps: 2,
      gameStr: '0000000000000000000000000000000011111100001111110000111111000022222200002222220000222222000022222200001111110000111111000011111100000000000000000000000000000000'
    },
    {
      level: 4,
      prefectSteps: 3,
      gameStr: '0000000000000000000022222222222000000002201111110220122221022012112102201211210220121121022012112102201222210220111111022000000002222222222200000000000000000000'
    },
    {
      level: 5,
      prefectSteps: 5,
      gameStr: '0001101100001100011001100200111100222001100220220010220102201002202200110022200101100200110011000110000110110020001110002200010002022000002200220002200002202200'
    },
    {
      level: 6,
      prefectSteps: 3,
      gameStr: '1100022200110002220011000222001100022222100002112212211211221221121122122112222210011222222201121100220112110022011211002110020011211002001121100200112222220011'
    },
    {
      level: 7,
      prefectSteps: 4,
      gameStr: '0000000000000000000000000000000001111111000111111100011222220001122222000112200000011220000001122000000112200022022110112202211011222000011122222111112222211111'
    },
    {
      level: 8,
      prefectSteps: 4,
      gameStr: '0000000000222222222211111111111111111111222222222200000000000110110110011011011000000000002222222222222222222200000000000000000000000000000011111111111111111111'
    },
    {
      level: 9,
      prefectSteps: 4,
      gameStr: '2222222222200200000220020222022222021202222202220222220000022222222222222222222221111111122122222212212111121221210012122121111212212222221221111111122222222222'
    }
  ]
</script>
</body>
</html>
